<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Murgi's Notes 🌚</title>
  <style>
    body {
      font-family: sans-serif;
      margin: 20px;
    }

    textarea {
      width: 100%;
      height: 300px;
      margin-bottom: 10px;
    }

    input,
    button {
      margin-bottom: 10px;
      padding: 10px;
    }

    #password::placeholder {
      font-family: "Courier New", monospace;
    }

    #status {
      font-weight: bold;
    }

    #changeStatus {
      font-weight: bold;
      color: red;
      margin-left: 10px;
    }
  </style>
</head>

<body>
  <p><a style="color: black; text-decoration: none;" href="https://github.com/faizul118/notes" target="_blank"><b style="font-size: larger;">Murgi's Notes 🌚</b></a>
    <br>
    <code>Born on 20241228_1620</code>
  </p>
  <input type="password" placeholder="password" id="password" />
  <button style="margin-left: 8px;" id="commitNotes">Commit</button>
  <br>
  <p><b id="status"></b><span id="changeStatus"></span></p>
  <textarea spellcheck="false" id="notes"></textarea>

  <script>
    const commitNotesButton = document.getElementById('commitNotes');
    const notesTextarea = document.getElementById('notes');
    const patInput = document.getElementById('password');
    const statusMessage = document.getElementById('status');
    const changeStatusMessage = document.getElementById('changeStatus');

    let fileSha = '';
    let originalContent = '';

    // Get password from URL and remove it immediately
    function getPasswordFromUrl() {
      const urlParams = new URLSearchParams(window.location.search);
      const password = urlParams.get('password');
      
      if (password) {
        // Remove the password from the URL
        const url = new URL(window.location);
        url.searchParams.delete('password');
        window.history.replaceState({}, document.title, url.pathname); // Update the URL without reloading
      }
      
      return password;
    }

    const passwordFromUrl = getPasswordFromUrl();
    if (passwordFromUrl) {
      patInput.value = passwordFromUrl; // Set the password field with the extracted value
    }

    async function fetchNotes() {
      const password = patInput.value;

      statusMessage.textContent = '⏳ [Fetch] In progress...';
      changeStatusMessage.textContent = '';

      try {
        let headers = {};
        if (password) {
          headers['Authorization'] = `Bearer ${password}`;
        }

        const response = await fetch(`https://api.github.com/repos/faizul118/notes/contents/notes.txt`, {
          headers: headers
        });

        if (response.ok) {
          const data = await response.json();
          const content = atob(data.content);
          notesTextarea.value = content;
          originalContent = content;
          fileSha = data.sha;
          statusMessage.textContent = '✅ [Fetch] OK';
        } else {
          statusMessage.textContent = '❎ [Fetch] Error: ' + response.statusText;
        }
      } catch (error) {
        console.error(error);
        statusMessage.textContent = '❎ [Fetch] Unknown error';
      }
    }

    async function commitNotes() {
      const notes = notesTextarea.value;

      if (notes === originalContent) {
        statusMessage.textContent = '⚠️ [Commit] Nothing to commit';
        statusMessage.classList.remove('modified');
        return;
      }

      statusMessage.textContent = '⏳ [Commit] In progress...';
      const password = patInput.value;

      if (!password) {
        alert('Password wen?');
        statusMessage.textContent = '❎ [Commit] No password';
        changeStatusMessage.textContent = '+ commit pending';
        statusMessage.classList.remove('modified');
        return;
      }

      if (!fileSha) {
        alert('Notes wher?');
        statusMessage.textContent = '❎ [Commit] Idk what this error is :/';
        changeStatusMessage.textContent = '+ commit pending';
        statusMessage.classList.remove('modified');
        return;
      }

      try {
        const response = await fetch(`https://api.github.com/repos/faizul118/notes/contents/notes.txt`, {
          method: 'PUT',
          headers: {
            'Authorization': `Bearer ${password}`,
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({
            message: 'Updated notes.txt',
            content: btoa(notes),
            sha: fileSha
          })
        });

        if (response.ok) {
          const data = await response.json();
          fileSha = data.content.sha;
          originalContent = notes;
          statusMessage.textContent = '✅ [Commit] OK!';
          changeStatusMessage.textContent = '';
          statusMessage.classList.remove('modified');
        } else {
          statusMessage.textContent = '❎ [Commit] Error: Maybe wrong password?';
          changeStatusMessage.textContent = '+ commit pending';
          statusMessage.classList.add('modified');
        }
      } catch (error) {
        console.error(error);
        statusMessage.textContent = '❎ [Commit] Unknown error';
        changeStatusMessage.textContent = '+ commit pending';
        statusMessage.classList.add('modified');
      }
    }

    notesTextarea.addEventListener('input', () => {
      if (notesTextarea.value !== originalContent) {
        changeStatusMessage.textContent = '+ commit pending';
        statusMessage.classList.add('modified');
      } else {
        changeStatusMessage.textContent = '';
        statusMessage.classList.remove('modified');
      }
    });

    commitNotesButton.addEventListener('click', commitNotes);
    fetchNotes();
  </script>

</body>

</html>
