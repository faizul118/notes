<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Murgi's Notes üåö</title>
  <style>
    body {
      font-family: sans-serif;
      margin: 20px;
    }

    textarea {
      width: 100%;
      height: 300px;
      margin-bottom: 10px;
    }

    input,
    button {
      margin-bottom: 10px;
      padding: 10px;
    }

    #password::placeholder {
      font-family: "Courier New", monospace;
    }
  </style>
</head>

<body>
  <p><b style="font-size: larger;">Murgi's Notes üåö</b>
    <br>
    <code>Born on 20241228_1620</code>
  </p>
  <input type="password" placeholder="password" id="password" />
  <button style="margin-left: 8px;" id="commitNotes">Commit</button>
  <br>
  <p id="status" style="font-weight: bold;"></p>
  <p id="modifiedStatus" style="font-weight: bold; color: orange; display: none;">‚úèÔ∏è Modified (not committed)</p>
  <br>
  <textarea spellcheck="false" id="notes"></textarea>

  <script>
    const commitNotesButton = document.getElementById('commitNotes');
    const notesTextarea = document.getElementById('notes');
    const patInput = document.getElementById('password');
    const statusMessage = document.getElementById('status');
    const modifiedStatus = document.getElementById('modifiedStatus');

    let fileSha = ''; // To store the file's SHA for commits
    let originalContent = ''; // To store the original content for comparison

    // Function to extract the password from the URL
    function getPasswordFromUrl() {
      const urlParams = new URLSearchParams(window.location.search);
      return urlParams.get('password');
    }

    // Function to remove the password from the URL
    function removePasswordFromUrl() {
      const url = new URL(window.location);
      url.searchParams.delete('password');
      window.history.replaceState({}, document.title, url.pathname);
    }

    // Set the password input automatically if it's present in the URL
    const passwordFromUrl = getPasswordFromUrl();
    if (passwordFromUrl) {
      patInput.value = passwordFromUrl;
      removePasswordFromUrl(); // Remove password from the URL after retrieving it
    }

    async function fetchNotes() {
      const password = patInput.value;

      statusMessage.textContent = '‚è≥ [Fetch] In progress...';

      try {
        let headers = {};
        // If password is provided, use it as the Authorization header
        if (password) {
          headers['Authorization'] = `Bearer ${password}`;
        }

        const response = await fetch(`https://api.github.com/repos/faizul726/notes/contents/notes.txt`, {
          headers: headers
        });

        if (response.ok) {
          const data = await response.json();
          const content = atob(data.content); // Decode the base64 content
          notesTextarea.value = content;
          originalContent = content; // Store the original content
          fileSha = data.sha; // Store the file's SHA for later commits
          statusMessage.textContent = '‚úÖ [Fetch] OK';
        } else {
          statusMessage.textContent = '‚ùé [Fetch] Error: ' + response.statusText;
        }
      } catch (error) {
        console.error(error);
        statusMessage.textContent = '‚ùé [Fetch] Unknown error';
      }
    }

    async function commitNotes() {
      statusMessage.textContent = '‚è≥ [Commit] In progress...';
      const password = patInput.value;
      const notes = notesTextarea.value;

      if (!password) {
        alert('Password wen?');
        statusMessage.textContent = '‚ùé [Commit] No password';
        return;
      }

      if (!fileSha) {
        alert('Notes wher?');
        statusMessage.textContent = '‚ùé [Commit] Idk what this error is :/';
        return;
      }

      try {
        const response = await fetch(`https://api.github.com/repos/faizul726/notes/contents/notes.txt`, {
          method: 'PUT',
          headers: {
            'Authorization': `Bearer ${password}`,
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({
            message: 'Updated notes.txt',
            content: btoa(notes), // Encode the notes to base64
            sha: fileSha
          })
        });

        if (response.ok) {
          const data = await response.json();
          fileSha = data.content.sha; // Update the SHA after the commit
          originalContent = notes; // Update the original content
          modifiedStatus.style.display = 'none'; // Hide "Modified" indicator
          statusMessage.textContent = '‚úÖ [Commit] OK!';
        } else {
          statusMessage.textContent = '‚ùé [Commit] Error: Maybe wrong password?';
        }
      } catch (error) {
        console.error(error);
        statusMessage.textContent = '‚ùé [Commit] Unknown error';
      }
    }

    // Event listener to show "Modified" indicator
    notesTextarea.addEventListener('input', () => {
      if (notesTextarea.value !== originalContent) {
        modifiedStatus.style.display = 'block'; // Show the "Modified" indicator
      } else {
        modifiedStatus.style.display = 'none'; // Hide the "Modified" indicator
      }
    });

    commitNotesButton.addEventListener('click', commitNotes);

    // Fetch the notes on page load
    fetchNotes();
  </script>
</body>

</html>
